---
title: "Open Canada Vital Statistics Tracker"
github-repo: open-canada/vitals
url: https\://open-canada.github.io/Apps/vitals
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
    vertical_layout: fill
runtime: shiny
resource_files:
- 13100810-2021-12-18.Rds
---

<!--
MIT License

Copyright (c) 2021 open-canada

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->


```{r -globals, include=F}
knitr::opts_chunk$set(echo = F)
#0. Global settings ----

if (T) {  
    # packages <- c("magrittr","ggplot2","stringr", "forcats")
    # lapply(packages, library, character.only = TRUE)
  library(lubridate,  quietly=T); options(lubridate.week.start =  1)
  library(data.table); options(datatable.print.class=TRUE)
  library(plotly); library(DT); 
  library(forcats) 
  library(ggpubr)
  
  dateToday <- format(Sys.time(), '%d %B, %Y') %>% dmy; dateToday
    "%wo%" <- function(x, y) setdiff(x,y) 
    `%ni%` <-  Negate(`%in%`)
}


# 1. Read cashed Table 13-10-0810-01 merged with GEO -----

# Canadian Vital Statistics Death (CVSD) Database
# Leading causes of death, total population 
# Provisional weekly death counts, by selected grouped causes of death
# Table: 13-10-0810-01
# Release date: 2021-11-08

# https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001
# https://www150.statcan.gc.ca/n1/tbl/csv/13100810-eng.zip


if (F) { # 1.a Save cached from live CANSIM data ----
    
    # Read StatCan data directly from StatCan site. 
    # NB: Works only if StatCan site is up and running.
    # You can test if it is running by clicking here: https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001
    
    library(cansim) # (See https://cran.r-project.org/web/packages/cansim) 
    dt <- cansim::get_cansim("13-10-0810-01") %>%  setDT(dt)
    # Quick view of the data
    dt
    dt %>% names 
    # Remove unneeded columns and simplify values
    # dt[, (names(dt)[c(1,3:20,24)]):=NULL]
    dt <- dt[, c("Date", "GEO", "val_norm", "Cause of death (ICD-10)")]
    dt[, Date := ymd(Date)]
    dt$GEO %>% unique() %>% sort
    dt[, GEO := gsub(", place of occurrence", "", GEO)]
    
    saveRDS(dt, paste0("13100810-", dateToday, ".Rds")) # save locally as compressed Rds file
    fwrite(dt, paste0("13100810-", dateToday, ".csv"), sep = "\t")
    fwrite(dt[Date >= ymd("2019-09-01")], paste0("13100810-", dateToday, "-after-20150901.csv"), sep = "\t")
}

if  (F)  { # 1.b Read from https://github.com/open-canada/datasets/statcan ----
    
    # downloader::download("https://github.com/open-canada/cansim-examples/raw/main/13100810-20211206.Rds", "13100810-20211206b.Rds") # order way
    curl::curl_download("https://github.com/open-canada/datasets/raw/main/statcan/13100810.Rds", "13100810.Rds")
    dt <- readRDS("13100810.Rds") 
    
    # Or load csv (for just last two years)
    dt <- fread ("https://github.com/open-canada/datasets/raw/main/statcan/13100810.csv") 
}

# 1.c Read local cached copy ----

dateCached <- ymd("20211218")
dt <- readRDS(paste0("13100810-", dateCached, ".Rds"))
# dt[, GEO := gsub(", place of occurrence", "", GEO)]
dt %>% setDT

dateMax <- dt$Date %>% max (na.rm=T) %>% ymd; dateMax
dt[c(1,.N)]
dt %>% names

choicesGEO <-  dt$GEO %>% unique(); choicesGEO
choicesCauses <- dt$`Cause of death (ICD-10)` %>% unique(); choicesCauses

# dt <- dt[Date >= ymd("2019-09-01")]

# 2. Merge with population, compute rates per million----

if (T) {
  dtGeo <- data.table(
    GEO = c(  "Ontario", "Quebec", "British Columbia", "Alberta",
              "Manitoba", "Saskatchewan", "Nova Scotia", "New Brunswick",
              "Newfoundland and Labrador", "Prince Edward Island", "Northwest Territories", "Nunavut", "Yukon", "Canada"  ),
    population = c( 14826276, 8604495, 5214805, 4442879, 1383765, 1179844, 992055, 789225, 
                    520553, 164318, 45504, 39403, 42986, 38246108 )
  )
  fwrite(dtGeo, "dtGeoCanada.csv", sep = "\t")
} else {
  dtGeo <- fread("dtGeoCanada.csv")
}

# dtGeo[, GEO:=fct_relevel(GEO, choicesGEO)]

dt <- dtGeo[dt, on="GEO"]
dt [, rate:=round(1000000*val_norm/population)]

dt[, GEO:=fct_relevel(GEO, choicesGEO)]


# 3. Merge it with Vaccination data -----

# Alternative source:
# dtVac2 <- fread("vaccination-coverage-byVaccineType-2021-12-07.csv", stringsAsFactors = T)


# strVac <- "vaccination-coverage-byAgeAndSex-overTimeDownload-2021-12-07.csv"
# strVac <- "https://health-infobase.canada.ca/src/data/covidLive/vaccination-coverage-byAgeAndSex-overTimeDownload.csv"
# fwrite(dtVac, "vaccination-coverage-byAgeAndSex-overTimeDownload-2021-12-07.csv")
# dtVac <- fread(strVac, stringsAsFactors = F)
# saveRDS(dtVac, "vaccination-coverage-byAgeAndSex-overTimeDownload-2021-12-07.Rds")
dtVac <- readRDS("vaccination-coverage-byAgeAndSex-overTimeDownload-2021-12-07.Rds")

dtVac[.N]
dtVac %>% names
dtVac <- dtVac[sex=="All sexes", c(2, 4:7,9)]

dtVac[, week_end := ymd(week_end)]
setnames(dtVac, old=c("prename", "week_end"), new=c("GEO", "Date"))

dtVac %>% names
colValues <- c("numtotal_atleast1dose","numtotal_fully"  )
dtVac[, (colValues):=lapply(.SD, as.numeric), .SDcols=colValues]

dtVac$GEO  %>% unique() 
# dtVac[, prename:=fct_reorder(prename, numtotal_fully, min)]
dtVac[, GEO:=fct_relevel(GEO, choicesGEO)]

dtVac$age %>% unique
dtVacAllAges <- 
  dtVac [, lapply(.SD, sum, na.rm=T), by=c("GEO", "Date"), .SD=colValues]

# dtAll <- dtVacAllAges[dt, on=.(prename=GEO, week_end=Date)]
dtAll <- dtVacAllAges[dt, on=c("GEO", "Date")]


# 4.a Set parameters: static ----

in0 <- list(
  # remove province with low count
  state = choicesGEO %wo% c("Yukon", "Northwest Territories", "Nunavut"), 
  # state <- choicesGEO %in% c("Canada", "Quebec" , "Ontario", "Alberta", "British Columbia" ), # Start with largest
  cause = choicesCauses[c(1,2,5, 12, 15:16)], # 5:9, # Start with largest
  live=F,
  national = F,
  vaccination=T,
  alternative_view=F,
  date = c("2019-12-01", as.character(dateToday))
)

if ( !shiny::isRunning() ) { # DOES NOT WORK ...ssometimes
  cat("Relax - Shiny is NOT Running :)")
  input <- in0
}

```


# Search criteria: {.sidebar data-width=210}
<!-- ## Search criteria {data-height=1000} -->




Data for `r format(dateToday, '%d %B %Y')`   
<!-- Cached on `r format(dateCached, '%d %B %Y')` -->
<!-- Live data is here () -->

<!-- 
Data Sources : <br>
- Death Causes data: [Statistics Canada CANSIM Table 13-10-0810-01](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001) <br>
- Vaccination data: https://health-infobase.canada.ca/covid-19/vaccination-coverage
-->



```{r shiny_input}

# 4.b Set parameters: interactive ----

checkboxInput("live", h5("Read live data instead of cached (may take time)"),  in0$live) 

checkboxInput("alternative_view", h5("Reverse axes"),  in0$alternative_view) 
checkboxInput("vaccination", h5("Include vaccination"),  in0$vaccination)
selectInput('state', h5("Choose Regions:"), multiple=T, choices = choicesGEO, selected = in0$state, selectize=F, size=10 )
selectInput('cause', h5("Choose Death Causes:"), multiple=T, choices = choicesCauses, selected = in0$cause, selectize=F, size=10    )

dateRangeInput("date", h4("Change date range"), weekstart=1, start = in0$date[1], end = in0$date[2])

```


#  Deaths 

## .... Upper Row {.tabset .tabset-fade }


<!-- ### Plot -->
### Multi-dimensional plot

```{r r.dt0 ggplot}

# .reactive <- function(A) {
#   if (!shiny::isRunning()) A else reactive(A)
# }



r.dtAll  <- reactive({
  dtAll
})



r.dt0  <- reactive({
  dt0 <- r.dtAll()[ Date >= input$date[1] &  Date <= input$date[2] & GEO %in% input$state & 
                  as.character(`Cause of death (ICD-10)`) %in% input$cause  ]
  dt0
})

r.g <- reactive({
  
  dt0 <- r.dt0()
  dt0$vaccination <- factor("Vaccination", levels=c("Vaccination", "Dummy") )
  
  if (input$alternative_view == T) {
    g1 <-  ggplot(dt0) +  theme(legend.position = "bottom") + 
      # guides(col="none") +
      geom_step(aes(Date, rate, col = `Cause of death (ICD-10)`)) +
      facet_grid(`Cause of death (ICD-10)` ~ GEO , scales = "free") +
      labs(        title = NULL,         x = NULL,         y = "Deaths in a million / week", 
                   caption = "Source: Statistics Canada - Table 13-10-0810-01"     )
    
    if (input$vaccination==T) {
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, 100*numtotal_fully/population), col = "red") +
        # geom_line(aes(Date, numtotal_partially), col = "red", linetype=3) +
        geom_line(aes(Date, 100*numtotal_atleast1dose/population), col = "red", linetype=2) +   
        facet_grid( vaccination ~ GEO , scales = "free") +
        labs(      title = "Canadian Vaccination and Vital Statistics data",         x = NULL,        y = "(%)", 
                   caption = "Source: https://health-infobase.canada.ca/covid-19/vaccination-coverage"  )
      # a <- max(1, input$cause %>% length - 4)
      a=5
   
      g <- ggpubr::ggarrange(g2, g1, nrow = 2, heights = c(1,a))
    } else {
      g <- g1
    }
    
  } else {
    
    g1 <-  ggplot(dt0) +  guides(col="none")  + 
      # guides(col="none") +
      geom_step(aes(Date, val_norm, col = `Cause of death (ICD-10)`)) +
      facet_grid(GEO ~ `Cause of death (ICD-10)`, scales = "free") +
      labs(        title = NULL,         x = NULL,        y = "Deaths / week", 
                   caption = "Source: Statistics Canada"     )
    
    if (input$vaccination==T) {
      
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, 100*numtotal_fully/population), col = "red") +
        geom_line(aes(Date, 100*numtotal_atleast1dose/population), col = "red", linetype=2) +   
        facet_grid(GEO ~ vaccination , scales = "free") +
        labs(      title = NULL,         x = NULL,        y = "Vaccination rate (%)", 
                   caption = "Source: https://health-infobase.canada.ca"  )
      
      g <- ggpubr::ggarrange(g1, g2, ncol = 2, widths=c(5,1))
      
    } else {
      g <- g1
    }
    
  }
  g
})


renderPlot( r.g() )


```


###  Interactive plot

Plot on the top shows data for all causes in  one region  (the first in the list of selected region).
Plot on the bottom shows data for  all regions in one cause  (the first in the list of selected causes).
<!-- Plots below shows data by cause and by region. -->
Dashed lines show the vaccination rate, when this option is selected in menu.

##### How use to interactive plot:

- Select/deselect any line by clicking on line description on right (Double-click  reverts the selection).
- Zoom on any section by drugging mouse of the region of interest in the  plot (Double-click on the plot restores original plot).
- Hover over a lines to see data details.
- For more options, use the buttons in the upper right corner of the plot image. You can move, change, reset and save plot image using the buttons there.


```{r ggplotly}
# if (input$vaccination==F) {
#   plotly::ggplotly( r.g() )
# }

plotly::renderPlotly( {
  
  dt0 <- r.dt0()
  # Interactive plot can visualize only data for one region
  region <- dt0$GEO %>% unique %>% .[1]
  g <-ggplot(dt0[GEO==region]) +
    geom_line(aes(Date, rate,   col = `Cause of death (ICD-10)`)) +
    labs(        title = "Deaths statistics"  ,         x = NULL,        y = "Deaths in a million (per week)"  )
  
  if (input$vaccination==T) {
    
    g <-  g +
      geom_line(aes(Date, 100*numtotal_fully/population), col = "red", linetype=2) +
      geom_line(aes(Date, 100*numtotal_atleast1dose/population), col = "red", linetype=3) +
      labs(        title = region  ,         x = NULL,        y = "Vaccinatrion rate (%) | Deaths in a million (per week)"  )
  }
  plotly::ggplotly( g ) 
})


plotly::renderPlotly( {
  
  dt0 <- r.dt0()
  cause1 <- dt0$`Cause of death (ICD-10)`%>% unique %>% .[1] 
  # Interactive plot can visualize only data for one cause
  g <-
    dt0[`Cause of death (ICD-10)` == cause1] %>% 
    ggplot() +
    geom_line(aes(Date, rate,  col = GEO)) +
    labs(        title = "Deaths statistics"  ,         x = NULL,        y = "Deaths in a million (per week)"  )
  
  if (input$vaccination==T) {
    
    g <-  g +
      geom_line(aes(Date, 100*numtotal_fully/population, col = GEO), linetype=2) +
      geom_line(aes(Date, 100*numtotal_atleast1dose/population, col = GEO), linetype=3) +
      labs(        title = cause1  ,         x = NULL,        y = "Vaccinatrion rate (%) | Deaths in a million (per week)"  )
  }
  plotly::ggplotly( g ) 
})



```

###  Interactive Table


Table below shows the raw data that is extracted from Open Canada databases using the selection criteria chosen in the menu.

##### How use to interactive table:

- Move / reorganize columns by drugging column names.  Change the number of rows to be shown using "Show entries" pull-down menu
- Filter by typing in the  boxes under the column names. Sort by clicking on the column name.
- Export table or its selection in one of  available formats using the buttons provided.

```{r datatable}

DT::renderDataTable( 
  r.dt0() %>% DT::datatable (
    filter = "top",  rownames=F,   
    extensions =  c('ColReorder', 'Buttons'),
    options = list(
      dom = 'Blfrtip',
      colReorder = TRUE,
      lengthMenu = list(c(10,25,100,-1), c(10,25,100,"All")),
      buttons = c('copy', 'csv', 'excel', 'pdf', 'print') 
    ) )
)


```



# Births

## .....

### Plot

A place-holder for additional Vital Statistics  data



# About {data-icon="fa-info-circle"}


```{r -meta, include=F}
library(metathis)
meta() %>%
  meta_description(
    "Open Canada Vital Statistics Tracker App enables interactive visualization of various Open Canada vital statistics databases data"
  ) %>%
  meta_name("github-repo" = "open-canada/vitals") %>%
  meta_viewport() %>%
  meta_social(
    title = "Open Canada Vital Statistics Tracker App",
    url = "https://open-canada.github.io/Apps/vitals",
    image = "https://github.com/open-canada/r4gc/raw/main/images/rCanada-octogon.png",
    image_alt = "o-Canada Vitals Logo",
    og_type = "app",
    og_author = c("R4GC Community"),
  )   %>%
  meta_general(
    # keywords = "open canada, statistics, vital databases, cases, deaths, births, covidcanada, covid", # This does not work
    application_name = "Vital Statistics Tracker App",
    theme_color = "#4285f4",
    description = "",
    robots = "index,follow",
    generator = "R-Shiny",
    subject = "Open Canada projects",
    rating = "General",
    referrer = "no-referrer"
  )
``` 

## .... Upper Row {.tabset .tabset-fade }


<!-- title: "Open Canada Vital Statistics Tracker" -->
<!-- subtitle: "Open Source Tool for Visualizing Open Data" -->


### About the App

The Open Canada Vital Statistics Tracker App is developed by the R4GC Community. 
The code is under MIT license and is free to use by anyone.
All the data is under Open Government License - Canada (http://open.canada.ca/en/open-government-licence-canada).

For official information related to *Cases  following vaccination*,  see COVID-19 Daily Epidemiology Update at [https://health-infobase.canada.ca/covid-19/epidemiological-summary-covid-19-cases.html](https://health-infobase.canada.ca/covid-19/epidemiological-summary-covid-19-cases.html#a9).
The authoritative source for COVID-19 information is [Canada.ca/coronavirus](https://canada.ca/coronavirus) or or [covid-19.Ontario.ca](https://covid-19.ontario.ca/) 

<!-- It is free to use by anyone under the  MIT License.  -->

<!-- The Open Canada Vital Statistics Tracker  -->
<!-- #subtitle: "Open Source Tool for Visualizing Open Data" -->


#### Data Sources: 


<!-- #### Vaccination data -->


<!-- Information on COVID-19 doses administered and vaccination coverage: -->


Cumulative number and percent of people who have received a COVID-19 vaccine in Canada by vaccination status, age group, sex, and jurisdiction: 

- https://health-infobase.canada.ca/covid-19/vaccination-coverage 
- Direct link: https://health-infobase.canada.ca/src/data/covidLive/vaccination-coverage-byAgeAndSex-overTimeDownload.csv




<!-- #### Vital Statistics - Death Database -->

<!-- Leading causes of death, total population (age standardization using 2011 population) -->
<!-- Provisional weekly death counts, by selected grouped causes of death   -->
<!-- Frequency: Weekly   -->
<!-- Table: 13-10-0810-01   -->
<!-- https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001    -->


Provisional weekly death counts, by selected grouped causes of death:    

- [Statistics Canada, Table 13-10-0810-01](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001)   
- Direct link: https://www150.statcan.gc.ca/n1/tbl/csv/13100810-eng.zip


##### Notes


<font size=-1>


<!-- (from to [Statistics Canada, Table 13-10-0810-01](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001):  -->


Footnote 3   
During the production of each month's death statistics, data from previous months/years may be revised to reflect any updates or changes that have been received from the provincial and territorial vital statistics offices.

Footnote 4   
Data for the reference years 2020 and 2021 are provisional due to the shortened duration of data collection.

Footnote 14   
The cause of death tabulated is the underlying cause of death. This is defined as (a) the disease or injury which initiated the train of events leading directly to death, or (b) the circumstances of the accident or violence which produced the fatal injury. The underlying cause is selected from the conditions listed on the medical certificate of cause of death.

Footnote 16   
The causes of death list included in this table is based on the 10 leading causes of death in 2018 and COVID-19 deaths. The list for leading causes of death is based on the list that was developed and that is being used by the National Center for Health Statistics of the United States in their annual report on leading causes of death.


Footnote 17    
"Other causes of death" is a residual to other deaths listed in this table. "Information unavailable" is a category which includes deaths for which the medical certificate of cause of death (for Provinces and Territories sending death certificates to Statistics Canada for coding) or the underlying cause of death code (for Provinces coding causes of death) has not yet been received at Statistics Canada.

Footnote 18    
Starting with the 2013 reference year, a new automated coding system was used to select the underlying cause of death. In 2017, an updated version of this coding system was implemented. For more information or to obtain documentation regarding the impact of these changes, please contact Statistics Canada's Statistical Information Service (toll-free 1-800-263-1136; 514-283-8300; STATCAN.infostats-infostats.STATCAN@Canada.ca).

Footnote 19    
The total, all causes of death and the number of deaths for which information on the causes of death is unavailable are based on the estimates presented in table 13-10-0792-01.


</font>



### References


```{r STOP_HERE, include=FALSE}
knitr::knit_exit()
```

Any other codes/text, which you dont want to be shown (yet) in the complied App, can be placed here. For example debugging pane or extra statistical analysis tab



# Statistical Analysis

### Correlations

```{r Correlations}


# dt0 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  %$% # CAUSE="Blank (NA)"

renderPrint({
  dt0 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  %$% # CAUSE="Blank (NA)"
  res <- dt0 %$%  cor.test(val_norm1, numtotal_fully, method="kendall")
})
# cor = 0.7553008, p-value = 0.000118 # pearson
# tau = 0.9894737 # kendall
# rho = 0.9984962 # spearman

```

# Debug 

## ...

### Input values



```{r print input}
renderPrint( input )
renderPrint( input$date )
```

