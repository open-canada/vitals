---
title: "Open Canada Vital Statistics Tracker"
github-repo: open-canada/vitals
url: https\://open-canada.github.io/Apps/vitals
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    # social: [ "twitter", "facebook", "linkedin", "pinterest" ]
    # source_code: embed
    source_code: https://github.com/open-canada/vitals
    vertical_layout: fill
runtime: shiny
# resource_files:
# - 13100810-cached.Rds
---


<!-- Great interactive charts: https://jkunst.com/flexdashboard-highcharter-examples/pokemon/ -->

```{r 00_vital_meta.Rmd, child = '00_vital_meta.Rmd'}
```


```{r -globals, include=F}
knitr::opts_chunk$set(echo = F)
source ("01_vitals_ca_LTE.R")

if (F) {
  dtCached 
  dateToday
  dateMax
  dateCached
  choicesGEO
  choicesCauses
  dtVac
}
if (T) {
  # For faster/memory efficient processing declare these as global 
  # in OOP, these would part of the class
  dt <- data.table()
  dtAll <- data.table()
  dt0 <- data.table()
  region1 <- ""
  cause1 <- ""
}

# 4.a Set parameters: static ----

in0 <- list(
  # remove provincecount
  state = choicesGEO %wo% c("Yukon", "Northwest Territories", "Nunavut"), 
  # state <- choicesGEO %in% c("Canada", "Quebec" , "Ontario", "Alberta", "British Columbia" ), # Start with largest
  cause = choicesCauses[c(1,2,5, 12, 15:16)], # 5:9, # Start with largest
  # live=F,
  # age=F,
  # national = F,
  vaccination=T,
  alternative_view=F,
  per_million = T,
  date = c("2019-12-01", as.character(dateToday))
)

if ( !shiny::isRunning() ) { # DOES NOT WORK when Shiny is running?
  cat("Relax - Shiny is NOT Running :)")
  input <- in0
}

```


# Search criteria: {.sidebar data-width=210}

<font size=-1>





Data Source: [Statistics Canada Table 13-10-0810-01](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001)


```{r shiny_input}
renderText(paste0("Data loaded on: ", ifelse(input$read_from=="Cached Data" , dateCached %>% as.character(), dateToday%>% as.character() )))
renderText(paste0("Last record in data: ", r.dt0()$Date %>% max(na.rm = T)))

# 4.b Set parameters: interactive ----



radioButtons("read_from", NULL, # "Read data from ",
             choices = c("Use Live", "Cached Data" ),
             selected = "Cached Data" , inline=T)
# checkboxInput("live", h5("Read data from source instead of cache (slower)"),  in0$live)


checkboxInput("alternative_view", "Reverse axes",  in0$alternative_view) 


# checkboxInput("age", h5("Include age information"),  in0$age)
# h6("* Not Available for death causes")
checkboxInput("per_million", "Show per million",  in0$per_million)

checkboxInput("vaccination", "Show vaccination data",  in0$vaccination)


selectInput('state', h5("Choose Regions:"), multiple=T, choices = choicesGEO, selected = in0$state, selectize=F, size=5 )
selectInput('cause', h5("Choose Death Causes:"), multiple=T, choices = choicesCauses, selected = in0$cause, selectize=F, size=5    )


# hr()

# radioButtons("compare_by", NULL, #"Track by ",
#              choices = c("Track by Cause", "Province" ),
#              selected = "Province", inline=T)



# checkboxInput("average", "Average over three weeks",  in0$smooth)
# checkboxInput("compare2past", "Compare to past years",  in0$compare2past)

dateRangeInput("date", h5("Change date range"), weekstart=1, start = in0$date[1], end = in0$date[2])

```


</font>



```{r r.dtAll r.dt0 }

# .reactive <- function(A) { # does not work :(   
#   if (!shiny::isRunning()) A else reactive(A)
# }


r.dtAll  <- reactive({
  
  
  if (input$read_from=="Cached Data") {
    dt = copy(dtCached)
  } else {
    # req(r.dtFile1())
    # req(input$read_from)
    # r.dtFile1()  %>% select(input$columns1)   %>%
    #          mutate_if(is.factor, as.character) 

    dt <- cansim::get_cansim("13-10-0810-01") %>%  setDT(dt)
    # Quick view of the data
    dt
    dt %>% names 
    # Remove unneeded columns and simplify values
    # dt[, (names(dt)[c(1,3:20,24)]):=NULL]
    dt <- dt[, c("Date", "GEO", "val_norm", "Cause of death (ICD-10)")]
    dt[, Date := ymd(Date)]; 
    dateMax <- dt$Date %>% max; dateMax # "2021-10-02"
    dateLive <- dateToday
    dt$GEO %>% unique() %>% sort
    dt[, GEO := gsub(", place of occurrence", "", GEO)]
    
    # dt <- dtGeo[dt, on="GEO"]
    dt[, GEO:=fct_relevel(GEO, choicesGEO)]
    setnames(dt, "val_norm", "value")
    setcolorder(dt, c("Date",  "GEO", "Cause of death (ICD-10)", "value"))
  }
  
  
  if (input$per_million==T) {
    dt <- dtGeo[dtCached, on="GEO"]
    dt [, GEO:=fct_relevel(GEO, choicesGEO)]
    dt [, value:=round(1000000*value/population)]
    setcolorder(dt, c("Date",  "GEO", "population", "Cause of death (ICD-10)", "value"))
  } 
  
  # if (input$average==T) {
  #   convolution_window <- 3 
  #   dt[, value := frollmean(value, convolution_window, align = "right", fill = 0), by = .(GEO, `Cause of death (ICD-10)`)]
  # }
  # 
  # if (input$clumpAllOtherCauses==T) {
  #   
  # }
  
  # dt <- dt[!is.na(val_norm)]
  
  if (input$vaccination==F) {
    dtAll = dt 
  } else {
    dtVacAllAgesAllSexes <- # because causes don report age ad sex
      dtVac [sex == "All sexes", lapply(.SD, sum, na.rm=T), by=c("GEO", "Date"), .SD=colValues]
    
    # dtAll <- dtVacAllAgesAllSexes[dt, on=.(prename=GEO, week_end=Date)]
    dtAll <- dtVacAllAgesAllSexes[dt, on=c("GEO", "Date")]
    dtAll[, GEO:=fct_relevel(GEO, choicesGEO)]
    
    # dtAll [, numtotal_atleast1dose:=round(100*numtotal_atleast1dose/population)]
    # dtAll [, numtotal_fully:=round(100*numtotal_fully/population)]
  }
  
  
})


r.dt0  <- reactive({
  
  q <- quote(Date >= input$date[1] &  Date <= input$date[2] & GEO %in% input$state & as.character(`Cause of death (ICD-10)`) %in% input$cause )

  # dt0 <- dtAll[eval(q)] # for testing offline
    # r.dtAll()[ 
   
  dt0 <- r.dtAll()[eval(q)]
})

```


# Deaths by Cause

## ........ {.tabset .tabset-fade }


<!-- ### Plot -->
### Multi-dimensional plot

```{r r.g}

r.g <- reactive({
  
  dt0 <- r.dt0()
  dt0$vaccination <- factor("Vaccination", levels=c("Vaccination", "Dummy") )
  
  if (input$alternative_view == T) {
    g1 <-  ggplot(dt0) +  theme(legend.position = "bottom") + 
      # guides(col="none") +
      geom_step(aes(Date, value, col = `Cause of death (ICD-10)`)) +
      facet_grid(`Cause of death (ICD-10)` ~ GEO , scales = "free") +
      labs(        title = NULL,         x = NULL,         y = "Deaths per week", 
                   caption = "Source: Statistics Canada - Table 13-10-0810-01"     )
    
    if (input$vaccination==T) {
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, numtotal_fully), col = "red") +
        # geom_line(aes(Date, numtotal_partially), col = "red", linetype=3) +
        geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=2) +   
        facet_grid( vaccination ~ GEO , scales = "free") +
        labs(      title = "Canadian Vaccination and Vital Statistics data",         x = NULL,        y = "(%)", 
                   caption = "Source: https://health-infobase.canada.ca/covid-19/vaccination-coverage"  )
      # a <- max(1, input$cause %>% length - 4)
      a=5
      
      g <- ggpubr::ggarrange(g2, g1, nrow = 2, heights = c(1,a))
    } else {
      g <- g1
    }
    
  } else {
    
    g1 <-  ggplot(dt0) +  guides(col="none")  + 
      # guides(col="none") +
      geom_step(aes(Date, value, col = `Cause of death (ICD-10)`)) +
      facet_grid(GEO ~ `Cause of death (ICD-10)`, scales = "free") +
      labs(        title = NULL,         x = NULL,        y = "Deaths per week", 
                   caption = "Source: Statistics Canada"     )
    
    if (input$vaccination==T) {
      
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, numtotal_fully), col = "red") +
        geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=2) +   
        facet_grid(GEO ~ vaccination , scales = "free") +
        labs(      title = NULL,         x = NULL,        y = "Vaccination rate (%)", 
                   caption = "Source: https://health-infobase.canada.ca"  )
      
      g <- ggpubr::ggarrange(g1, g2, ncol = 2, widths=c(5,1))
      
    } else {
      g <- g1
    }
    
  }
  g
})


renderPlot( r.g() )


```


###  Interactive plot 

Plot on the top shows data for all causes in  one region  (the first in the list of selected regions).   
Plot on the bottom shows data for  all regions in one cause  (the first in the list of selected causes).
<!-- Plots below shows data by cause and by region. -->
<!-- Dashed lines show the vaccination rate, when this option is selected in menu. -->

##### How use to interactive plot:

- Select/deselect any line by clicking on line description on right (Double-click  reverts the selection).
- Zoom on any section by drugging mouse of the region of interest in the  plot (Double-click on the plot restores original plot).
- Hover over a line to see data details.
- For more options, use the buttons in the upper right corner of the plot image. You can move, change, reset and save plot image using the buttons there.


```{r ggplotly}
# if (input$vaccination==F) {
#   plotly::ggplotly( r.g() )
# }

plotly::renderPlotly( {
  
  dt0 <- r.dt0()
  # Interactive plot can visualize only data for one region
  region1 <- dt0$GEO %>% unique %>% .[1]
  g <-ggplot(dt0[GEO==region1]) +
    geom_line(aes(Date, value,   col = `Cause of death (ICD-10)`)) +
    labs(        title = paste0("Region: ", region1)  ,         x = NULL,        y = "Deaths per week"  )
  
  # if (F) {
  # # if (input$vaccination==T) {
  #   g <-  g +
  #     geom_line(aes(Date, numtotal_fully), col = "red", linetype=2) +
  #     geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=3) +
  #     labs(        title = region  ,         x = NULL,        y = "Vaccinatrion rate (%) | Deaths in a million (per week)"  )
  # }
  plotly::ggplotly( g ) 
})


plotly::renderPlotly( {
  
  dt0 <- r.dt0()
  cause1 <- dt0$`Cause of death (ICD-10)`%>% unique %>% .[1] 
  # Interactive plot can visualize only data for one cause
  g <-
    dt0[`Cause of death (ICD-10)` == cause1] %>% 
    ggplot() +
    geom_line(aes(Date, value,  col = GEO)) +
    labs(        title = paste0("Cause: ", cause1)  ,         
                 x = NULL,        y = "Deaths per week"  )
  
  # if (input$vaccination==T) {
  #   g <-  g +
  #     geom_line(aes(Date, numtotal_fully, col = GEO), linetype=2) +
  #     geom_line(aes(Date, numtotal_atleast1dose, col = GEO), linetype=3) +
  #     labs(        title = cause1  ,         x = NULL,        y = "Vaccinatrion rate (%) | Deaths in a million (per week)"  )
  # }
  plotly::ggplotly( g ) 
})



```



###  Interactive time-series 

Plot shows time-series for all causes in  one region  (the first in the list of the selected regions).   

```{r r.dt0_wideGeo1 dygraphs}



r.dt0_wideGeo1 <- reactive({
  dt0 <- r.dt0()
  region1 <<- dt0$GEO %>% unique %>% .[1]
  
  # dt0_wideGeo1 <- dt0[Date >= "2020-01-01" & GEO==region1, !c("GEO"), with=T] %>% dcast(... ~ `Cause of death (ICD-10)`)
  dt0_wideGeo1 <- dt0[GEO == region1, !c("GEO"), with = T] %>% dcast( Date ~ `Cause of death (ICD-10)`, value.var = "value")
  # dt0_wideGeo1 <- dt0[Date >= "2020-01-01" & GEO == region1, !c("GEO"), with = T] %>% dcast( ... ~ `Cause of death (ICD-10)`, value.var = "value")
  dt0_wideGeo1
  
})

dygraphs::renderDygraph ({
  dt0_wideGeo1 <- r.dt0_wideGeo1 () 
  
  # setcolorder(dt0_wideGeo1, "Date"); 
  dts  <- as.xts.data.table(dt0_wideGeo1)
  
  dygraph.title( dts, region1)
})


# r.dt0_wideCause1 <- reactive({
#   dt0 <- r.dt0()
#   cause1 <<- dt0$`Cause of death (ICD-10)`%>% unique %>% .[1]
# 
#   dt0_wideCause1 <- dt0[`Cause of death (ICD-10)`, !c("Cause of death (ICD-10)"), with=T] %>% dcast(Date ~ GEO, value.var="value")
#   dt0_wideCause1
# })

# dygraphs::renderDygraph ({
#   dygraph.title( r.dt0_wideCause1 () )
# })

```


<!-- ```{r STOP_HERE_0, include=FALSE} -->
<!-- knitr::knit_exit() -->
<!-- ``` -->



###  Interactive table


Table below shows  data extracted using the selection criteria chosen in the menu. 
NB: It can take long to display large quantities of data.

##### How use to interactive table:

- Move / reorganize columns by drugging column names.  Change the number of rows to be shown using "Show entries" pull-down menu
- Filter by typing in the  boxes under the column names. Sort by clicking on the column name.
- Export table or its selection in one of  available formats using the buttons provided.

```{r datatable}

DT::renderDataTable( 
  r.dt0() %>% DT::datatable (
    filter = "top",  rownames=F,   
    extensions =  c('ColReorder', 'Buttons'),
    options = list(
      dom = 'Blfrtip',
      colReorder = TRUE,
      # lengthMenu = list(c(10,25,100,-1), c(10,25,100,"All")),
      buttons = c('copy', 'csv', 'excel', 'pdf', 'print') 
    ) )
)


```






<!-- 

# Births

## .....

### Plot

A place-holder for additional Vital Statistics  data

-->




# Deaths by Age

## ........ {.tabset .tabset-fade }

### Plot

UNDER DEVELOPMENT


```{r eval=FALSE, include=FALSE}
# 5. Open Deaths by Age ----


dtAge <- readRDS(paste0(id, ".Rds")) %>% setDT
if ( is.na(dtAge[.N]$GEO) ) {
  dateCached <- dtAge[.N]$Date %>% ymd
  dtAge <- dtAge[1:(.N-1)]
}

setnames(dtAge, old=c("Age at time of death", "Sex"), new=c("age", "sex"))

```



```{r 99_vital_info.Rmd, child = '99_vital_info.Rmd'}
```



```{r STOP_HERE, include=FALSE}
knitr::knit_exit()
```
Any other codes/text, which you dont want to be shown (yet) in the complied App, can be placed here. For example debugging pane or extra statistical analysis tab



# Debug 

## ...

### Debug window



#### Input
```{r print input1}
# renderPrint( paste0("Shiny is Running: ", shiny::isRunning() ) )
renderPrint( input )
renderPrint( input$date )
renderPrint( paste0("region1 ", region1))
renderPrint( paste0("cause1 ", cause1))

# cat("r.dtAll()")
# renderPrint( r.dtAll() %>% print )
cat("r.dt0()")
renderPrint( r.dt0() %>% print )
cat("r.dt0_wideGeo1()")
renderPrint( r.dt0_wideGeo1() %>% print )
```





<!-- # Statistical Analysis 


### Correlations

```{r Correlations}


# dt0 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  %$% # CAUSE="Blank (NA)"

renderPrint({
  dt00 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  # CAUSE="Blank (NA)"
    res <- dt00 %$%  cor.test(val_norm, numtotal_fully, method="kendall")
})
# cor = 0.7553008, p-value = 0.000118 # pearson
# tau = 0.9894737 # kendall
# rho = 0.9984962 # spearman




setkey(dt0.wide,"Date")

r <- cor(dt0.wide[, !("Date"), with=T])
p <- cor.test.p(dt0.wide)

heatmaply(dt0.wide)

```


-->