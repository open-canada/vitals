---
title: "Open Canada Vital Statistics Tracker"
github-repo: open-canada/vitals
url: https\://open-canada.github.io/Apps/vitals
license: MIT 
# favicon: "rCanada.ico"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    # social: [ "twitter", "facebook", "linkedin", "pinterest" ]
    # source_code: embed
    source_code: https://github.com/open-canada/vitals
    vertical_layout: fill # scroll #fill # 
runtime: shiny
# resource_files:
# - 13100810-cached.Rds
---


<!-- Great interactive charts: https://jkunst.com/flexdashboard-highcharter-examples/pokemon/ -->

```{r 00_vital_meta.Rmd, child = '00_vital_meta.Rmd'}
```


```{r -globals, include=F}
knitr::opts_chunk$set(echo = F)
source ("01_vitals_ca_LTE.R")

if (F) {
  dtCached 
  dateToday
  dateMax
  dateCached
  choicesGEO
  choicesCauses
  dtVac
}
if (T) {
  # For faster/memory efficient processing declare these as global 
  # in OOP, these would part of the class
  dt <- data.table()
  dtAll <- data.table()
  dt0 <- data.table()
  region1 <- ""
  cause1 <- ""
}

# * 4.a Set parameters: static ----

in0 <- list(
  read_from="Cached Data",
  state = choicesGEO %wo% c("Yukon", "Northwest Territories", "Nunavut"), 
  # state <- choicesGEO %in% c("Canada", "Quebec" , "Ontario", "Alberta", "British Columbia" ), # Start with largest
  cause = choicesCauses[c(1,2,5, 7, 12, 15:16)], # 5:9, # Start with largest
  # live=F,
  # age=F,
  average = F,
  vaccination=T,
  alternative_view=F,
  per_million = T,
  keep_scale = T,
  compare2past = F,
  
  date = c("2019-12-01", as.character(dateToday))
)

if ( !shiny::isRunning() ) { # DOES NOT WORK when Shiny is running?
  cat("Relax - Shiny is NOT Running :)")
  input <- in0
}

```


# Search criteria: {.sidebar data-width=210}

<font size=-1>





Data Source: [Statistics Canada Table 13-10-0810-01](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310081001)


```{r shiny_input}

dateCached = ymd("2022-01-07")
dateReleased = ymd("2021-12-06"); 
# dateCached = dateReleased

renderText(paste0("Data loaded on: ", ifelse(input$read_from=="Cached Data" , dateCached %>% as.character(), dateToday%>% as.character() )))
renderText(paste0("Last record in data: ", r.dt0()$Date %>% max(na.rm = T)))

# 4.b Set parameters: interactive ----



radioButtons("read_from", NULL, # "Read data from ",
             choices = c("Use Live", "Cached Data" ),
             selected = "Cached Data" , inline=T)
# checkboxInput("live", h5("Read data from source instead of cache (slower)"),  in0$live)


checkboxInput("alternative_view", "Reverse axes",  in0$alternative_view) 


# checkboxInput("age", h5("Include age information"),  in0$age)
# h6("* Not Available for death causes")
checkboxInput("per_million", "Show per million",  in0$per_million)

checkboxInput("average", "Average over three weeks",  in0$average)

checkboxInput("keep_scale", "Keep the same scale",  T)


checkboxInput("vaccination", "Show vaccination data",  in0$vaccination)


selectInput('state', h5("Select Regions:"), multiple=T, choices = choicesGEO, selected = in0$state, selectize=F, size=5 )
selectInput('cause', h5("Select Death Causes:"), multiple=T, choices = choicesCauses, selected = in0$cause, selectize=F, size=5    )


# hr()

# radioButtons("compare_by", NULL, #"Track by ",
#              choices = c("Track by Cause", "Province" ),
#              selected = "Province", inline=T)




# checkboxInput("compare2past", "Compare to past years",  in0$compare2past)

# 
# listRanges <- list(
#   "* Set manually*"="manually",
#   `Pre-pandemic:` = list(
#     "example 1-a (6 records)",
#     "American(350 records)"
#   ), 
# )
# 
# selectInput(
#   "dataset1",   "Select date period:",  listRanges,   
#   selected = "uploaded",
#   # selectize=F, size=4,
#   multiple = F
# )
# 

renderUI({
  
  dateRangeInput("date", h5("Select date range"), weekstart=1, start = in0$date[1], end = in0$date[2])
  
})

```


</font>



```{r *r.dtAll}

# .reactive <- function(A) { # does not work :(   
#   if (!shiny::isRunning()) A else reactive(A)
# }


r.dtAll  <- reactive({
  
  
  if (input$read_from=="Cached Data") {
    dt = copy(dtCached)
  } else {
    # req(r.dtFile1())
    # req(input$read_from)
    # r.dtFile1()  %>% select(input$columns1)   %>%
    #          mutate_if(is.factor, as.character) 

    dt <- cansim::get_cansim("13-10-0810-01") %>%  setDT(dt)
    # Quick view of the data
    dt
    dt %>% names 
    # Remove unneeded columns and simplify values
    # dt[, (names(dt)[c(1,3:20,24)]):=NULL]
    dt <- dt[, c("Date", "GEO", "val_norm", "Cause of death (ICD-10)")]
    dt[, Date := ymd(Date)]; 
    dateMax <- dt$Date %>% max; dateMax # "2021-10-02"
    dateLive <- dateToday
    dt$GEO %>% unique() %>% sort
    dt[, GEO := gsub(", place of occurrence", "", GEO)]
    
    # dt <- dtGeo[dt, on="GEO"]
    dt[, GEO:=fct_relevel(GEO, choicesGEO)]
    setnames(dt, "val_norm", "value")
    setcolorder(dt, c("Date",  "GEO", "Cause of death (ICD-10)", "value"))
  }
  
  
  if (input$per_million==T) {
    dt <- dtGeo[dtCached, on="GEO"]
    dt [, GEO:=fct_relevel(GEO, choicesGEO)]
    dt [, value:=round(1000000*value/population)]
    setcolorder(dt, c("Date",  "GEO", "population", "Cause of death (ICD-10)", "value"))
  } 
  
  if (input$average==T) {
    convolution_window <- 3
    dt[, value := frollmean(value, convolution_window, align = "right", fill = 0), by = .(GEO, `Cause of death (ICD-10)`)]
  }

  # if (input$clumpAllOtherCauses==T) {
  # 
  # }
  
  # dt <- dt[!is.na(val_norm)]
  
  if (input$vaccination==F) {
    dtAll = dt 
  } else {
    dtVacAllAgesAllSexes <- # because causes don report age ad sex
      dtVac [sex == "All sexes", lapply(.SD, sum, na.rm=T), by=c("GEO", "Date"), .SD=colValues]
    
    # dtAll <- dtVacAllAgesAllSexes[dt, on=.(prename=GEO, week_end=Date)]
    dtAll <- dtVacAllAgesAllSexes[dt, on=c("GEO", "Date")]
    dtAll[, GEO:=fct_relevel(GEO, choicesGEO)]
    
    # dtAll [, numtotal_atleast1dose:=round(100*numtotal_atleast1dose/population)]
    # dtAll [, numtotal_fully:=round(100*numtotal_fully/population)]
  }
  
  
})

```

```{r *r.dt0 r.dtSummary}

r.dt0  <- reactive({
  
  q <- quote(Date >= input$date[1] &  Date <= input$date[2] & GEO %in% input$state & as.character(`Cause of death (ICD-10)`) %in% input$cause )

  # dt0 <- dtAll[eval(q)] # for testing offline
    # r.dtAll()[ 
   
  dt0 <<- r.dtAll()[eval(q)]
})

r.dtSummary  <- reactive({
  dt0 <<- r.dt0()
  
  # if (!input$vaccination) {
    dtS <- dt0 [ , .(
      `Weekly lowest`=min(value, na.rm = T) %>% round(0),    
      `Weekly average`=mean(value, na.rm = T) %>% round(0),     
      `Weekly highest`=max(value, na.rm = T) %>% round(0),
      `Weekly dynamics`=( lm(value ~ as.integer( Date - min(Date)),  na.action=na.omit)$coefficients[2] * 7 ) %>% round(1)
    ),    by=.(`Cause of death (ICD-10)`,GEO)]
  # } else{
  #   dtS <- dt0 [ , .(
  #     # `Full vacc. rate average (%)`=mean(numtotal_fully, na.rm = T)%>% round(1),
  #     # `Patial vacc. rate average (%)`=mean(numtotal_atleast1dose, na.rm = T)%>% round(1), 
  #     `Weekly lowest`=min(value, na.rm = T),    
  #     `Weekly average`=mean(value, na.rm = T) %>% round(1),     
  #     `Weekly highest`=max(value, na.rm = T),
  #     `Weekly dynamics`=( lm(value ~ as.integer( Date - min(Date)),  na.action=na.omit)$coefficients[2] * 7 ) %>% round(1)
  #   ),    by=.(`Cause of death (ICD-10)`,GEO)] 
  # }
  dtS
})

```

# Deaths 

<!-- # Deaths by Cause -->

## ........ {.tabset .tabset-fade }


### Overview
<!-- ### Multi-dimensional plot -->

```{r *r.g }

# out.width="100%", out.height="100%" 
r.g <- reactive({
  
  dt0 <<- r.dt0()
  dt0$vaccination <- factor("Vaccination", levels=c("Vaccination", "Dummy") )
  
  if (input$alternative_view == F) {
    g1 <-  ggplot(dt0) +  theme(legend.position = "bottom") + 
      # guides(col="none") +
        # guides(x =  guide_axis(angle = 90)) +
      # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  # scale_x_discrete(guide = guide_axis(angle = 90)) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      geom_line(aes(Date, value, col = `Cause of death (ICD-10)`)) +
      facet_grid(`Cause of death (ICD-10)` ~ GEO , 
                 scales = ifelse (input$keep_scale, "fixed", "free")
                 ) +
      labs(        title = NULL,         x = NULL,         
                   y = ifelse(input$per_million,  "Deaths in million / week", "Deaths / week"), 
                   caption = "Source: Statistics Canada - Table 13-10-0810-01"     )
    
    if (input$vaccination==T) {
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, numtotal_fully), col = "red") +
        # geom_line(aes(Date, numtotal_partially), col = "red", linetype=3) +
        geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=2) +   
        facet_grid( vaccination ~ GEO , scales = "free") +
        labs(title = NULL,  x = NULL,         
             y = "(%)",
             caption = "Source: https://health-infobase.canada.ca/covid-19/vaccination-coverage")
      # a <- max(1, input$cause %>% length - 4)
      a=5
      
      g <- ggpubr::ggarrange(g2, g1, nrow = 2, heights = c(1,a))
    } else {
      g <- g1
    }
    
  } else {
    
    g1 <-  ggplot(dt0) +  guides(col="none")  + 
      # guides(col="none") +
      geom_line(aes(Date, value, col = `Cause of death (ICD-10)`)) +
      facet_grid(GEO ~ `Cause of death (ICD-10)`, 
                 scales = ifelse (input$keep_scale, "fixed", "free")
                 ) +
      labs(title = NULL,  x = NULL,         
           y = ifelse(input$per_million,  "Deaths in million / week", "Deaths / week"), 
           caption = "Source: Statistics Canada - Table 13-10-0810-01" )
    
    if (input$vaccination==T) {
      
      g2 <-  ggplot(dt0) +   guides(col="none") +
        geom_line(aes(Date, numtotal_fully), col = "red") +
        geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=2) +   
        facet_grid(GEO ~ vaccination , scales = "free") +
        labs(      title = NULL,         x = NULL,        y = "Vaccination rate (%)", 
                   caption = "Source: https://health-infobase.canada.ca"  )
      
      g <- ggpubr::ggarrange(g1, g2, ncol = 2, widths=c(5,1))
      
    } else {
      g <- g1
    }
    
  }
  g
})


renderPlot( r.g() )


```



<!-- ###  Interactive time-series  -->

<!-- Plot shows time-series for all causes in  one region  (the first in the list of the selected regions).    -->

### By cause

```{r r.dt0_wideGeo1 dygraphs}



r.dt0_wideGeo1 <- reactive({
  dt0 <<- r.dt0()
  region1 <<- dt0$GEO %>% unique %>% .[1]
  
  # dt0_wideGeo1 <- dt0[Date >= "2020-01-01" & GEO==region1, !c("GEO"), with=T] %>% dcast(... ~ `Cause of death (ICD-10)`)
  dt0_wideGeo1 <- dt0[GEO == region1, !c("GEO"), with = T] %>% dcast( Date ~ `Cause of death (ICD-10)`, value.var = "value")
  
  dt0_wideGeo1
  
})

dygraphs::renderDygraph ({
  dt0_wideGeo1 <- r.dt0_wideGeo1 () 
  
  # setcolorder(dt0_wideGeo1, "Date"); 
  dts  <- as.xts.data.table(dt0_wideGeo1)
  
  # dygraph.title( dts, region1)
  
   dygraph(dts, main = region1) %>%
    # dySeries(input$var1, color = input$color1, strokePattern = input$stroke1,  axis = input$axis1 )  %>% 
    dyOptions(fillGraph = F, stepPlot = F, drawGrid = T, drawPoints = TRUE, pointSize = 2) %>%
    dyHighlight(highlightCircleSize = 5,highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE) %>%
    dyAxis("y", label=ifelse(input$per_million,  "Deaths in million / week", "Deaths / week")) %>%
    # dyAnnotation("2021-6-10", text = "10%", tooltip = "Fully Vaccinated Rate 10%") %>%
    # dyAnnotation("2021-5-1", text = "3%", tooltip = "Fully Vaccinated Rate 3%") %>%
    # dyAnnotation("2021-4-6", text = "2%", tooltip = "Fully Vaccinated Rate 2%") %>%
    # dyAnnotation("2021-2-18", text = "1%", tooltip = "Fully Vaccinated Rate 1%") %>%
    dyRangeSelector() 
  
})
```

### By province

```{r}

dygraphs::renderDygraph ({

  dt0 <- r.dt0()
  cause1 <<- dt0$`Cause of death (ICD-10)`%>% unique %>% .[1]

  dt0_wideCause1 <- dt0[`Cause of death (ICD-10)`==cause1, !c("Cause of death (ICD-10)"), with=T] %>% dcast(Date ~ GEO, value.var="value")
  
  dts  <- as.xts.data.table(dt0_wideCause1)

  dygraph.title( dts, cause1)
})

```


### By cause (alt.) 


```{r ggplotly}

plotly::renderPlotly( {
  
  dt0 <<- r.dt0()
  # Interactive plot can visualize only data for one region
  region1 <- dt0$GEO %>% unique %>% .[1]
  g <-ggplot(dt0[GEO==region1]) +
    geom_line(aes(Date, value,   col = `Cause of death (ICD-10)`)) +
    labs(        
      title = paste0(region1)  ,         
      x = NULL,
      y = ifelse(input$per_million,  "Deaths in million / week", "Deaths / week")  
      )
  
  if (input$vaccination==T) {
    g <-  g +
      geom_line(aes(Date, numtotal_fully), col = "red", linetype=2) +
      geom_line(aes(Date, numtotal_atleast1dose), col = "red", linetype=3) +
      labs(        
        title = region1  ,         
        x = NULL,        
        y = ifelse(input$per_million,  "Vaccinatrion rate (%) | Deaths in million per week", "Vaccinatrion rate (%) | Deaths per week")  
      )
  }
  
  plotly::ggplotly( g ) 
})

```


### By province (alt.)



```{r ggplotly2}

plotly::renderPlotly( {
  
  dt0 <- r.dt0()
  cause1 <- dt0$`Cause of death (ICD-10)`%>% unique %>% .[1] 
  # Interactive plot can visualize only data for one cause
  g <-
    dt0[`Cause of death (ICD-10)` == cause1] %>% 
    ggplot() +
    geom_line(aes(Date, value,  col = GEO)) +
    labs(        
      title = paste0(cause1)  ,         
      x = NULL,        
      y = ifelse(input$per_million,  "Deaths in million / week", "Deaths / week") 
      )
  
  if (input$vaccination==T) {
    g <-  g +
      geom_line(aes(Date, numtotal_fully, col = GEO), linetype=2) +
      geom_line(aes(Date, numtotal_atleast1dose, col = GEO), linetype=3) +
      labs(        
        title = cause1,         
        x = NULL,        
        y = ifelse(input$per_million,  "Vaccinatrion rate (%) | Deaths in million per week", "Vaccinatrion rate (%) | Deaths per week")   
      )
  }
  
  plotly::ggplotly( g ) 
})



```



###  Summary 




```{r datatable}
hr()

# radioButtons("show_table", NULL, 
#              choices = c("Show Summary", "Show Raw Data" ),
#              selected = "Show Summary" , inline=T)


DT::renderDataTable(
  # if (input$show_table == "Show Summary" )  {
    r.dtSummary() %>% datatable.title()
      # datatable.title("Summary (Deaths in a million per week)")
  # } else {
  #   dt0 <- r.dt0() 
  #   if (input$vaccination) {
  #     dt0 %>% dcast(GEO    +   Date + numtotal_atleast1dose + numtotal_fully ~ `Cause of death (ICD-10)`, value.var = "value") %>% .[order(GEO, -Date)] %>% setcolorder(c("GEO", "Date", input$cause)) %>% datatable.title("Vaccination & Deaths statistics (Deaths in a million per week)") 
  #   }else{
  #     dt0 %>% dcast(GEO    +   Date ~ `Cause of death (ICD-10)`, value.var = "value") %>% .[order(GEO,-Date)]  %>% 
  #       datatable.title("Deaths statistics (Deaths in a million per week)")     
  #   }
  #   
  #   
  # }
  
)


# r.dt0() %>% DT::datatable (
#       filter = "top",  rownames=F,
#       extensions =  c('ColReorder', 'Buttons'),
#       options = list(
#         dom = 'Blfrtip',
#         colReorder = TRUE,
#         # lengthMenu = list(c(10,25,100,-1), c(10,25,100,"All")),
#         buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
#       ) )


```



###  Full table


```{r}
DT::renderDataTable({
  
  dt0 <- r.dt0() 
  
  if (input$vaccination) {
    dt0 %>% dcast(GEO    +   Date + numtotal_atleast1dose + numtotal_fully ~ `Cause of death (ICD-10)`, value.var = "value") %>% .[order(GEO, -Date)] %>% setcolorder(c("GEO", "Date", input$cause)) %>% datatable.title("Vaccination & Deaths statistics (Deaths in a million per week)") 
  }else{
    dt0 %>% dcast(GEO    +   Date ~ `Cause of death (ICD-10)`, value.var = "value") %>% .[order(GEO,-Date)]  %>% datatable.title()
      # datatable.title("Deaths statistics (Deaths in a million per week)")     
  }
}
)


```

<!-- # Statistical Analysis  -->




 

# Births

## .....

### UNDER CONSTRUCTION

A place-holder for visualizing  [Other related Canadian Vital Statistics data]

Note that most  databases listed in [Other related Canadian Vital Statistics data] are updated annually and hence cannot be used for weekly time-series analysis enabled by this App.

<!-- and/or provide less granular data than the ones that are currently visualized by this App, and hence  -->




<!-- # Deaths by Age -->

<!-- ## ........ {.tabset .tabset-fade } -->

<!-- ### Plot -->

<!-- UNDER DEVELOPMENT -->


```{r eval=FALSE, include=FALSE}
# 5. Open Deaths by Age ----


dtAge <- readRDS(paste0(id, ".Rds")) %>% setDT
if ( is.na(dtAge[.N]$GEO) ) {
  dateCached <- dtAge[.N]$Date %>% ymd
  dtAge <- dtAge[1:(.N-1)]
}

setnames(dtAge, old=c("Age at time of death", "Sex"), new=c("age", "sex"))

```






```{r 99_vital_info.Rmd, child = '99_vital_info.Rmd'}
```



```{r STOP_HERE, include=FALSE}
knitr::knit_exit()
```
Any other codes/text, which you dont want to be shown (yet) in the complied App, can be placed here. For example debugging pane or extra statistical analysis tab



# Debug 

## ...

### Debug window



#### Input
```{r print input1}
# renderPrint( paste0("Shiny is Running: ", shiny::isRunning() ) )
renderPrint( input )
renderPrint( input$date )
renderPrint( paste0("region1 ", region1))
renderPrint( paste0("cause1 ", cause1))

# cat("r.dtAll()")
# renderPrint( r.dtAll() %>% print )
cat("r.dt0()")
renderPrint( r.dt0() %>% print )
cat("r.dt0_wideGeo1()")
renderPrint( r.dt0_wideGeo1() %>% print )
```




#### Statistical summary

```{r Summary}

```

#### Correlations

```{r Correlations}


# dt0 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  %$% # CAUSE="Blank (NA)"

renderPrint({
  dt00 <- dtAll[Date >= "2021-05-01" & GEO=="Canada" & `Cause of death (ICD-10)` == choicesCauses [16]]  # CAUSE="Blank (NA)"
  res <- dt00 %$%  cor.test(value, numtotal_fully, method="kendall")
})
# cor = 0.7553008, p-value = 0.000118 # pearson
# tau = 0.9894737 # kendall
# rho = 0.9984962 # spearman


# 
# 
# setkey(dt0.wide,"Date")
# 
# r <- cor(dt0.wide[, !("Date"), with=T])
# p <- cor.test.p(dt0.wide)
# 
# heatmaply(dt0.wide)
# 
# 
# # Statistical Analysis
# 
# 
# # http://www.sthda.com/english/wiki/correlation-test-between-two-variables-in-r
# 
# 
# res <- cor.test(x, y, method=c("pearson", "kendall", "spearman"))
# # If your data contain missing values, use the following R code to handle missing values by case-wise deletion.
# # cor(x, y,  method = "pearson", use = "complete.obs")
# 
# # Extract the p.value
# res$p.value
# # Extract the correlation coefficient
# res$estimate

```



